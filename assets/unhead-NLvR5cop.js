import{c as x}from"./hookable-B8xFkYCm.js";const W=new Set(["link","style","script","noscript"]),z=new Set(["title","titleTemplate","script","style","noscript"]),A=new Set(["base","meta","link","style","script","noscript"]),D=new Set(["title","base","htmlAttrs","bodyAttrs","meta","link","style","script","noscript"]),U=new Set(["base","title","titleTemplate","bodyAttrs","htmlAttrs","templateParams"]),I=new Set(["key","tagPosition","tagPriority","tagDuplicateStrategy","innerHTML","textContent","processTemplateParams"]),$=new Set(["templateParams","htmlAttrs","bodyAttrs"]),q=new Set(["theme-color","google-site-verification","og","article","book","profile","twitter","author"]),F=["name","property","http-equiv"];function O(t){const e=t.split(":")[1];return q.has(e)}function H(t){const{props:e,tag:n}=t;if(U.has(n))return n;if(n==="link"&&e.rel==="canonical")return"canonical";if(e.charset)return"charset";if(t.tag==="meta"){for(const o of F)if(e[o]!==void 0)return`${n}:${e[o]}`}if(t.key)return`${n}:key:${t.key}`;if(e.id)return`${n}:id:${e.id}`;if(z.has(n)){const o=t.textContent||t.innerHTML;if(o)return`${n}:content:${o}`}}function S(t){const e=t._h||t._d;if(e)return e;const n=t.textContent||t.innerHTML;return n||`${t.tag}:${Object.entries(t.props).map(([o,c])=>`${o}:${String(c)}`).join(",")}`}function C(t,e,n){typeof t==="function"&&(!n||n!=="titleTemplate"&&!(n[0]==="o"&&n[1]==="n"))&&(t=t());let c;if(e&&(c=e(n,t)),Array.isArray(c))return c.map(l=>C(l,e));if((c==null?void 0:c.constructor)===Object){const l={};for(const p of Object.keys(c))l[p]=C(c[p],e,p);return l}return c}function K(t,e){const n=t==="style"?new Map:new Set;function o(c){const l=c.trim();if(l)if(t==="style"){const[p,...u]=l.split(":").map(f=>f.trim());p&&u.length&&n.set(p,u.join(":"))}else l.split(" ").filter(Boolean).forEach(p=>n.add(p))}return typeof e=="string"?t==="style"?e.split(";").forEach(o):o(e):Array.isArray(e)?e.forEach(c=>o(c)):e&&typeof e=="object"&&Object.entries(e).forEach(([c,l])=>{l&&l!=="false"&&(t==="style"?n.set(c.trim(),l):o(c))}),n}function R(t,e){return t.props=t.props||{},e&&Object.entries(e).forEach(([n,o])=>{if(o===null){t.props[n]=null;return}if(n==="class"||n==="style"){t.props[n]=K(n,o);return}if(I.has(n)){if(["textContent","innerHTML"].includes(n)&&typeof o=="object"){let p=e.type;if(e.type||(p="application/json"),!(p!=null&&p.endsWith("json"))&&p!=="speculationrules")return;e.type=p,t.props.type=p,t[n]=JSON.stringify(o)}else t[n]=o;return}const c=String(o),l=n.startsWith("data-");c==="true"||c===""?t.props[n]=l?c:!0:!o&&l&&c==="false"?t.props[n]="false":o!==void 0&&(t.props[n]=o)}),t}function v(t,e){const n=typeof e=="object"&&typeof e!="function"?e:{[t==="script"||t==="noscript"||t==="style"?"innerHTML":"textContent"]:e},o=R({tag:t,props:{}},n);return o.key&&W.has(o.tag)&&(o.props["data-hid"]=o._h=o.key),o.tag==="script"&&typeof o.innerHTML=="object"&&(o.innerHTML=JSON.stringify(o.innerHTML),o.props.type=o.props.type||"application/json"),Array.isArray(o.props.content)?o.props.content.map(c=>({...o,props:{...o.props,content:c}})):o}function G(t,e){if(!t)return[];typeof t=="function"&&(t=t());const n=(c,l)=>{for(let p=0;p<e.length;p++)l=e[p](c,l);return l};t=n(void 0,t);const o=[];return t=C(t,n),Object.entries(t||{}).forEach(([c,l])=>{if(l!==void 0)for(const p of Array.isArray(l)?l:[l])o.push(v(c,p))}),o.flat()}const L=(t,e)=>t._w===e._w?t._p-e._p:t._w-e._w,E={base:-10,title:10},J={critical:-8,high:-1,low:2},P={meta:{"content-security-policy":-30,charset:-20,viewport:-15},link:{preconnect:20,stylesheet:60,preload:70,modulepreload:70,prefetch:90,"dns-prefetch":90,prerender:90},script:{async:30,defer:80,sync:50},style:{imported:40,sync:60}},V=/@import/,T=t=>t===""||t===!0;function N(t,e){var l;if(typeof e.tagPriority=="number")return e.tagPriority;let n=100;const o=J[e.tagPriority]||0,c=t.resolvedOptions.disableCapoSorting?{link:{},script:{},style:{}}:P;if(e.tag in E)n=E[e.tag];else if(e.tag==="meta"){const p=e.props["http-equiv"]==="content-security-policy"?"content-security-policy":e.props.charset?"charset":e.props.name==="viewport"?"viewport":null;p&&(n=P.meta[p])}else e.tag==="link"&&e.props.rel?n=c.link[e.props.rel]:e.tag==="script"?T(e.props.async)?n=c.script.async:e.props.src&&!T(e.props.defer)&&!T(e.props.async)&&e.props.type!=="module"&&!((l=e.props.type)!=null&&l.endsWith("json"))?n=c.script.sync:T(e.props.defer)&&e.props.src&&!T(e.props.async)&&(n=c.script.defer):e.tag==="style"&&(n=e.innerHTML&&V.test(e.innerHTML)?c.style.imported:c.style.sync);return(n||100)+o}function j(t,e){const n=typeof e=="function"?e(t):e,o=n.key||String(t.plugins.size+1);t.plugins.get(o)||(t.plugins.set(o,n),t.hooks.addHooks(n.hooks||{}))}function B(t={}){var u;const e=x();e.addHooks(t.hooks||{});const n=!t.document,o=new Map,c=new Map,l=[],p={_entryCount:1,plugins:c,dirty:!1,resolvedOptions:t,hooks:e,ssr:n,entries:o,headEntries(){return[...o.values()]},use:f=>j(p,f),push(f,b){const y={...b||{}};delete y.head;const m=y._index??p._entryCount++,M={_i:m,input:f,options:y},_={_poll(r=!1){p.dirty=!0,!r&&l.push(m),e.callHook("entries:updated",p)},dispose(){o.delete(m)&&_._poll(!0)},patch(r){(!y.mode||y.mode==="server"&&n||y.mode==="client"&&!n)&&(M.input=r,o.set(m,M),_._poll())}};return _.patch(f),_},async resolveTags(){var _;const f={tagMap:new Map,tags:[],entries:[...p.entries.values()]};for(await e.callHook("entries:resolve",f);l.length;){const r=l.shift(),s=o.get(r);if(s){const i={tags:G(s.input,t.propResolvers||[]).map(a=>Object.assign(a,s.options)),entry:s};await e.callHook("entries:normalize",i),s._tags=i.tags.map((a,d)=>(a._w=N(p,a),a._p=(s._i<<10)+d,a._d=H(a),a))}}let b=!1;f.entries.flatMap(r=>(r._tags||[]).map(s=>({...s,props:{...s.props}}))).sort(L).reduce((r,s)=>{const i=String(s._d||s._p);if(!r.has(i))return r.set(i,s);const a=r.get(i);if(((s==null?void 0:s.tagDuplicateStrategy)||($.has(s.tag)?"merge":null)||(s.key&&s.key===a.key?"merge":null))==="merge"){const h={...a.props};Object.entries(s.props).forEach(([w,g])=>h[w]=w==="style"?new Map([...a.props.style||new Map,...g]):w==="class"?new Set([...a.props.class||new Set,...g]):g),r.set(i,{...s,props:h})}else s._p>>10===a._p>>10&&O(s._d)?(r.set(i,Object.assign([...Array.isArray(a)?a:[a],s],s)),b=!0):(s._w===a._w?s._p>a._p:(s==null?void 0:s._w)<(a==null?void 0:a._w))&&r.set(i,s);return r},f.tagMap);const y=f.tagMap.get("title"),m=f.tagMap.get("titleTemplate");if(p._title=y==null?void 0:y.textContent,m){const r=m==null?void 0:m.textContent;if(p._titleTemplate=typeof r=="string"?r:void 0,r){let s=typeof r=="function"?r(y==null?void 0:y.textContent):r;typeof s=="string"&&!p.plugins.has("template-params")&&(s=s.replace("%s",(y==null?void 0:y.textContent)||"")),y?s===null?f.tagMap.delete("title"):f.tagMap.set("title",{...y,textContent:s}):(m.tag="title",m.textContent=s)}}f.tags=Array.from(f.tagMap.values()),b&&(f.tags=f.tags.flat().sort(L)),await e.callHook("tags:beforeResolve",f),await e.callHook("tags:resolve",f),await e.callHook("tags:afterResolve",f);const M=[];for(const r of f.tags){const{innerHTML:s,tag:i,props:a}=r;if(D.has(i)&&!(Object.keys(a).length===0&&!r.innerHTML&&!r.textContent)&&!(i==="meta"&&!a.content&&!a["http-equiv"]&&!a.charset)){if(i==="script"&&s){if((_=a.type)!=null&&_.endsWith("json")){const d=typeof s=="string"?s:JSON.stringify(s);r.innerHTML=d.replace(/</g,"\\u003C")}else typeof s=="string"&&(r.innerHTML=s.replace(new RegExp(`</${i}`,"g"),`<\\/${i}`));r._d=H(r)}M.push(r)}}return M}};return((t==null?void 0:t.plugins)||[]).forEach(f=>j(p,f)),p.hooks.callHook("init",p),(u=t.init)==null||u.forEach(f=>f&&p.push(f)),p}async function Q(t,e={}){const n=e.document||t.resolvedOptions.document;if(!n||!t.dirty)return;const o={shouldRender:!0,tags:[]};if(await t.hooks.callHook("dom:beforeRender",o),!!o.shouldRender)return t._domUpdatePromise||(t._domUpdatePromise=new Promise(async c=>{var _;const l=new Map,p=new Promise(r=>{t.resolveTags().then(s=>{r(s.map(i=>{const a=l.get(i._d)||0,d={tag:i,id:(a?`${i._d}:${a}`:i._d)||S(i),shouldRender:!0};return i._d&&O(i._d)&&l.set(i._d,a+1),d}))})});let u=t._dom;if(!u){u={title:n.title,elMap:new Map().set("htmlAttrs",n.documentElement).set("bodyAttrs",n.body)};for(const r of["body","head"]){const s=(_=n[r])==null?void 0:_.children;for(const i of s){const a=i.tagName.toLowerCase();if(!A.has(a))continue;const d=R({tag:a,props:{}},{innerHTML:i.innerHTML,...i.getAttributeNames().reduce((h,w)=>(h[w]=i.getAttribute(w),h),{})||{}});if(d.key=i.getAttribute("data-hid")||void 0,d._d=H(d)||S(d),u.elMap.has(d._d)){let h=1,w=d._d;for(;u.elMap.has(w);)w=`${d._d}:${h++}`;u.elMap.set(w,i)}else u.elMap.set(d._d,i)}}}u.pendingSideEffects={...u.sideEffects},u.sideEffects={};function f(r,s,i){const a=`${r}:${s}`;u.sideEffects[a]=i,delete u.pendingSideEffects[a]}function b({id:r,$el:s,tag:i}){const a=i.tag.endsWith("Attrs");u.elMap.set(r,s),a||(i.textContent&&i.textContent!==s.textContent&&(s.textContent=i.textContent),i.innerHTML&&i.innerHTML!==s.innerHTML&&(s.innerHTML=i.innerHTML),f(r,"el",()=>{s==null||s.remove(),u.elMap.delete(r)}));for(const d in i.props){if(!Object.prototype.hasOwnProperty.call(i.props,d))continue;const h=i.props[d];if(d.startsWith("on")&&typeof h=="function"){const g=s==null?void 0:s.dataset;if(g&&g[`${d}fired`]){const k=d.slice(0,-5);h.call(s,new Event(k.substring(2)))}s.getAttribute(`data-${d}`)!==""&&((i.tag==="bodyAttrs"?n.defaultView:s).addEventListener(d.substring(2),h.bind(s)),s.setAttribute(`data-${d}`,""));continue}const w=`attr:${d}`;if(d==="class"){if(!h)continue;for(const g of h)a&&f(r,`${w}:${g}`,()=>s.classList.remove(g)),!s.classList.contains(g)&&s.classList.add(g)}else if(d==="style"){if(!h)continue;for(const[g,k]of h)f(r,`${w}:${g}`,()=>{s.style.removeProperty(g)}),s.style.setProperty(g,k)}else h!==!1&&h!==null&&(s.getAttribute(d)!==h&&s.setAttribute(d,h===!0?"":String(h)),a&&f(r,w,()=>s.removeAttribute(d)))}}const y=[],m={bodyClose:void 0,bodyOpen:void 0,head:void 0},M=await p;for(const r of M){const{tag:s,shouldRender:i,id:a}=r;if(i){if(s.tag==="title"){n.title=s.textContent,f("title","",()=>n.title=u.title);continue}r.$el=r.$el||u.elMap.get(a),r.$el?b(r):A.has(s.tag)&&y.push(r)}}for(const r of y){const s=r.tag.tagPosition||"head";r.$el=n.createElement(r.tag.tag),b(r),m[s]=m[s]||n.createDocumentFragment(),m[s].appendChild(r.$el)}for(const r of M)await t.hooks.callHook("dom:renderTag",r,n,f);m.head&&n.head.appendChild(m.head),m.bodyOpen&&n.body.insertBefore(m.bodyOpen,n.body.firstChild),m.bodyClose&&n.body.appendChild(m.bodyClose);for(const r in u.pendingSideEffects)u.pendingSideEffects[r]();t._dom=u,await t.hooks.callHook("dom:rendered",{renders:M}),c()}).finally(()=>{t._domUpdatePromise=void 0,t.dirty=!1})),t._domUpdatePromise}function Y(t={}){var o,c,l;const e=((o=t.domOptions)==null?void 0:o.render)||Q;t.document=t.document||(typeof window<"u"?document:void 0);const n=((l=(c=t.document)==null?void 0:c.head.querySelector('script[id="unhead:payload"]'))==null?void 0:l.innerHTML)||!1;return B({...t,plugins:[...t.plugins||[],{key:"client",hooks:{"entries:updated":e}}],init:[n?JSON.parse(n):!1,...t.init||[]]})}function Z(t,e){let n=0;return()=>{const o=++n;e(()=>{n===o&&t()})}}export{Z as a,Y as c,Q as r};
