import{c as R}from"./hookable-B8xFkYCm.js";const D=new Set(["link","style","script","noscript"]),W=new Set(["title","titleTemplate","script","style","noscript"]),A=new Set(["base","meta","link","style","script","noscript"]),v=new Set(["title","base","htmlAttrs","bodyAttrs","meta","link","style","script","noscript"]),z=new Set(["base","title","titleTemplate","bodyAttrs","htmlAttrs","templateParams"]),U=new Set(["key","tagPosition","tagPriority","tagDuplicateStrategy","innerHTML","textContent","processTemplateParams"]),$=new Set(["templateParams","htmlAttrs","bodyAttrs"]),I=new Set(["theme-color","google-site-verification","og","article","book","profile","twitter","author"]),q=["name","property","http-equiv"],F=new Set(["viewport","description","keywords","robots"]);function O(t){const e=t.split(":");return e.length?I.has(e[1]):!1}function H(t){const{props:e,tag:n}=t;if(z.has(n))return n;if(n==="link"&&e.rel==="canonical")return"canonical";if(e.charset)return"charset";if(t.tag==="meta"){for(const o of q)if(e[o]!==void 0){const c=e[o],l=c.includes(":"),a=F.has(c),f=!(l||a)&&t.key?`:key:${t.key}`:"";return`${n}:${c}${f}`}}if(t.key)return`${n}:key:${t.key}`;if(e.id)return`${n}:id:${e.id}`;if(W.has(n)){const o=t.textContent||t.innerHTML;if(o)return`${n}:content:${o}`}}function C(t){const e=t._h||t._d;if(e)return e;const n=t.textContent||t.innerHTML;return n||`${t.tag}:${Object.entries(t.props).map(([o,c])=>`${o}:${String(c)}`).join(",")}`}function S(t,e,n){typeof t==="function"&&(!n||n!=="titleTemplate"&&!(n[0]==="o"&&n[1]==="n"))&&(t=t());let c;if(e&&(c=e(n,t)),Array.isArray(c))return c.map(l=>S(l,e));if((c==null?void 0:c.constructor)===Object){const l={};for(const a of Object.keys(c))l[a]=S(c[a],e,a);return l}return c}function K(t,e){const n=t==="style"?new Map:new Set;function o(c){const l=c.trim();if(l)if(t==="style"){const[a,...u]=l.split(":").map(f=>f.trim());a&&u.length&&n.set(a,u.join(":"))}else l.split(" ").filter(Boolean).forEach(a=>n.add(a))}return typeof e=="string"?t==="style"?e.split(";").forEach(o):o(e):Array.isArray(e)?e.forEach(c=>o(c)):e&&typeof e=="object"&&Object.entries(e).forEach(([c,l])=>{l&&l!=="false"&&(t==="style"?n.set(c.trim(),l):o(c))}),n}function x(t,e){return t.props=t.props||{},e&&Object.entries(e).forEach(([n,o])=>{if(o===null){t.props[n]=null;return}if(n==="class"||n==="style"){t.props[n]=K(n,o);return}if(U.has(n)){if(["textContent","innerHTML"].includes(n)&&typeof o=="object"){let a=e.type;if(e.type||(a="application/json"),!(a!=null&&a.endsWith("json"))&&a!=="speculationrules")return;e.type=a,t.props.type=a,t[n]=JSON.stringify(o)}else t[n]=o;return}const c=String(o),l=n.startsWith("data-");c==="true"||c===""?t.props[n]=l?c:!0:!o&&l&&c==="false"?t.props[n]="false":o!==void 0&&(t.props[n]=o)}),t}function V(t,e){const n=typeof e=="object"&&typeof e!="function"?e:{[t==="script"||t==="noscript"||t==="style"?"innerHTML":"textContent"]:e},o=x({tag:t,props:{}},n);return o.key&&D.has(o.tag)&&(o.props["data-hid"]=o._h=o.key),o.tag==="script"&&typeof o.innerHTML=="object"&&(o.innerHTML=JSON.stringify(o.innerHTML),o.props.type=o.props.type||"application/json"),Array.isArray(o.props.content)?o.props.content.map(c=>({...o,props:{...o.props,content:c}})):o}function G(t,e){if(!t)return[];typeof t=="function"&&(t=t());const n=(c,l)=>{for(let a=0;a<e.length;a++)l=e[a](c,l);return l};t=n(void 0,t);const o=[];return t=S(t,n),Object.entries(t||{}).forEach(([c,l])=>{if(l!==void 0)for(const a of Array.isArray(l)?l:[l])o.push(V(c,a))}),o.flat()}const L=(t,e)=>t._w===e._w?t._p-e._p:t._w-e._w,P={base:-10,title:10},J={critical:-8,high:-1,low:2},E={meta:{"content-security-policy":-30,charset:-20,viewport:-15},link:{preconnect:20,stylesheet:60,preload:70,modulepreload:70,prefetch:90,"dns-prefetch":90,prerender:90},script:{async:30,defer:80,sync:50},style:{imported:40,sync:60}},N=/@import/,_=t=>t===""||t===!0;function B(t,e){var l;if(typeof e.tagPriority=="number")return e.tagPriority;let n=100;const o=J[e.tagPriority]||0,c=t.resolvedOptions.disableCapoSorting?{link:{},script:{},style:{}}:E;if(e.tag in P)n=P[e.tag];else if(e.tag==="meta"){const a=e.props["http-equiv"]==="content-security-policy"?"content-security-policy":e.props.charset?"charset":e.props.name==="viewport"?"viewport":null;a&&(n=E.meta[a])}else e.tag==="link"&&e.props.rel?n=c.link[e.props.rel]:e.tag==="script"?_(e.props.async)?n=c.script.async:e.props.src&&!_(e.props.defer)&&!_(e.props.async)&&e.props.type!=="module"&&!((l=e.props.type)!=null&&l.endsWith("json"))?n=c.script.sync:_(e.props.defer)&&e.props.src&&!_(e.props.async)&&(n=c.script.defer):e.tag==="style"&&(n=e.innerHTML&&N.test(e.innerHTML)?c.style.imported:c.style.sync);return(n||100)+o}function j(t,e){const n=typeof e=="function"?e(t):e,o=n.key||String(t.plugins.size+1);t.plugins.get(o)||(t.plugins.set(o,n),t.hooks.addHooks(n.hooks||{}))}function Q(t={}){var u;const e=R();e.addHooks(t.hooks||{});const n=!t.document,o=new Map,c=new Map,l=new Set,a={_entryCount:1,plugins:c,dirty:!1,resolvedOptions:t,hooks:e,ssr:n,entries:o,headEntries(){return[...o.values()]},use:f=>j(a,f),push(f,T){const y={...T||{}};delete y.head;const m=y._index??a._entryCount++,M={_i:m,input:f,options:y},b={_poll(r=!1){a.dirty=!0,!r&&l.add(m),e.callHook("entries:updated",a)},dispose(){o.delete(m)&&a.invalidate()},patch(r){(!y.mode||y.mode==="server"&&n||y.mode==="client"&&!n)&&(M.input=r,o.set(m,M),b._poll())}};return b.patch(f),b},async resolveTags(){var b;const f={tagMap:new Map,tags:[],entries:[...a.entries.values()]};for(await e.callHook("entries:resolve",f);l.size;){const r=l.values().next().value;l.delete(r);const s=o.get(r);if(s){const i={tags:G(s.input,t.propResolvers||[]).map(p=>Object.assign(p,s.options)),entry:s};await e.callHook("entries:normalize",i),s._tags=i.tags.map((p,d)=>(p._w=B(a,p),p._p=(s._i<<10)+d,p._d=H(p),p))}}let T=!1;f.entries.flatMap(r=>(r._tags||[]).map(s=>({...s,props:{...s.props}}))).sort(L).reduce((r,s)=>{const i=String(s._d||s._p);if(!r.has(i))return r.set(i,s);const p=r.get(i);if(((s==null?void 0:s.tagDuplicateStrategy)||($.has(s.tag)?"merge":null)||(s.key&&s.key===p.key?"merge":null))==="merge"){const h={...p.props};Object.entries(s.props).forEach(([w,g])=>h[w]=w==="style"?new Map([...p.props.style||new Map,...g]):w==="class"?new Set([...p.props.class||new Set,...g]):g),r.set(i,{...s,props:h})}else s._p>>10===p._p>>10&&s.tag==="meta"&&O(i)?(r.set(i,Object.assign([...Array.isArray(p)?p:[p],s],s)),T=!0):(s._w===p._w?s._p>p._p:(s==null?void 0:s._w)<(p==null?void 0:p._w))&&r.set(i,s);return r},f.tagMap);const y=f.tagMap.get("title"),m=f.tagMap.get("titleTemplate");if(a._title=y==null?void 0:y.textContent,m){const r=m==null?void 0:m.textContent;if(a._titleTemplate=r,r){let s=typeof r=="function"?r(y==null?void 0:y.textContent):r;typeof s=="string"&&!a.plugins.has("template-params")&&(s=s.replace("%s",(y==null?void 0:y.textContent)||"")),y?s===null?f.tagMap.delete("title"):f.tagMap.set("title",{...y,textContent:s}):(m.tag="title",m.textContent=s)}}f.tags=Array.from(f.tagMap.values()),T&&(f.tags=f.tags.flat().sort(L)),await e.callHook("tags:beforeResolve",f),await e.callHook("tags:resolve",f),await e.callHook("tags:afterResolve",f);const M=[];for(const r of f.tags){const{innerHTML:s,tag:i,props:p}=r;if(v.has(i)&&!(Object.keys(p).length===0&&!r.innerHTML&&!r.textContent)&&!(i==="meta"&&!p.content&&!p["http-equiv"]&&!p.charset)){if(i==="script"&&s){if((b=p.type)!=null&&b.endsWith("json")){const d=typeof s=="string"?s:JSON.stringify(s);r.innerHTML=d.replace(/</g,"\\u003C")}else typeof s=="string"&&(r.innerHTML=s.replace(new RegExp(`</${i}`,"g"),`<\\/${i}`));r._d=H(r)}M.push(r)}}return M},invalidate(){for(const f of o.values())l.add(f._i);a.dirty=!0,e.callHook("entries:updated",a)}};return((t==null?void 0:t.plugins)||[]).forEach(f=>j(a,f)),a.hooks.callHook("init",a),(u=t.init)==null||u.forEach(f=>f&&a.push(f)),a}async function X(t,e={}){const n=e.document||t.resolvedOptions.document;if(!n||!t.dirty)return;const o={shouldRender:!0,tags:[]};if(await t.hooks.callHook("dom:beforeRender",o),!!o.shouldRender)return t._domUpdatePromise||(t._domUpdatePromise=new Promise(async c=>{var b;const l=new Map,a=new Promise(r=>{t.resolveTags().then(s=>{r(s.map(i=>{const p=l.get(i._d)||0,d={tag:i,id:(p?`${i._d}:${p}`:i._d)||C(i),shouldRender:!0};return i._d&&O(i._d)&&l.set(i._d,p+1),d}))})});let u=t._dom;if(!u){u={title:n.title,elMap:new Map().set("htmlAttrs",n.documentElement).set("bodyAttrs",n.body)};for(const r of["body","head"]){const s=(b=n[r])==null?void 0:b.children;for(const i of s){const p=i.tagName.toLowerCase();if(!A.has(p))continue;const d=x({tag:p,props:{}},{innerHTML:i.innerHTML,...i.getAttributeNames().reduce((h,w)=>(h[w]=i.getAttribute(w),h),{})||{}});if(d.key=i.getAttribute("data-hid")||void 0,d._d=H(d)||C(d),u.elMap.has(d._d)){let h=1,w=d._d;for(;u.elMap.has(w);)w=`${d._d}:${h++}`;u.elMap.set(w,i)}else u.elMap.set(d._d,i)}}}u.pendingSideEffects={...u.sideEffects},u.sideEffects={};function f(r,s,i){const p=`${r}:${s}`;u.sideEffects[p]=i,delete u.pendingSideEffects[p]}function T({id:r,$el:s,tag:i}){const p=i.tag.endsWith("Attrs");u.elMap.set(r,s),p||(i.textContent&&i.textContent!==s.textContent&&(s.textContent=i.textContent),i.innerHTML&&i.innerHTML!==s.innerHTML&&(s.innerHTML=i.innerHTML),f(r,"el",()=>{s==null||s.remove(),u.elMap.delete(r)}));for(const d in i.props){if(!Object.prototype.hasOwnProperty.call(i.props,d))continue;const h=i.props[d];if(d.startsWith("on")&&typeof h=="function"){const g=s==null?void 0:s.dataset;if(g&&g[`${d}fired`]){const k=d.slice(0,-5);h.call(s,new Event(k.substring(2)))}s.getAttribute(`data-${d}`)!==""&&((i.tag==="bodyAttrs"?n.defaultView:s).addEventListener(d.substring(2),h.bind(s)),s.setAttribute(`data-${d}`,""));continue}const w=`attr:${d}`;if(d==="class"){if(!h)continue;for(const g of h)p&&f(r,`${w}:${g}`,()=>s.classList.remove(g)),!s.classList.contains(g)&&s.classList.add(g)}else if(d==="style"){if(!h)continue;for(const[g,k]of h)f(r,`${w}:${g}`,()=>{s.style.removeProperty(g)}),s.style.setProperty(g,k)}else h!==!1&&h!==null&&(s.getAttribute(d)!==h&&s.setAttribute(d,h===!0?"":String(h)),p&&f(r,w,()=>s.removeAttribute(d)))}}const y=[],m={bodyClose:void 0,bodyOpen:void 0,head:void 0},M=await a;for(const r of M){const{tag:s,shouldRender:i,id:p}=r;if(i){if(s.tag==="title"){n.title=s.textContent,f("title","",()=>n.title=u.title);continue}r.$el=r.$el||u.elMap.get(p),r.$el?T(r):A.has(s.tag)&&y.push(r)}}for(const r of y){const s=r.tag.tagPosition||"head";r.$el=n.createElement(r.tag.tag),T(r),m[s]=m[s]||n.createDocumentFragment(),m[s].appendChild(r.$el)}for(const r of M)await t.hooks.callHook("dom:renderTag",r,n,f);m.head&&n.head.appendChild(m.head),m.bodyOpen&&n.body.insertBefore(m.bodyOpen,n.body.firstChild),m.bodyClose&&n.body.appendChild(m.bodyClose);for(const r in u.pendingSideEffects)u.pendingSideEffects[r]();t._dom=u,await t.hooks.callHook("dom:rendered",{renders:M}),c()}).finally(()=>{t._domUpdatePromise=void 0,t.dirty=!1})),t._domUpdatePromise}function Z(t={}){var o,c,l;const e=((o=t.domOptions)==null?void 0:o.render)||X;t.document=t.document||(typeof window<"u"?document:void 0);const n=((l=(c=t.document)==null?void 0:c.head.querySelector('script[id="unhead:payload"]'))==null?void 0:l.innerHTML)||!1;return Q({...t,plugins:[...t.plugins||[],{key:"client",hooks:{"entries:updated":e}}],init:[n?JSON.parse(n):!1,...t.init||[]]})}function tt(t,e){let n=0;return()=>{const o=++n;e(()=>{n===o&&t()})}}export{tt as a,Z as c,X as r};
